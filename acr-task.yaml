version: v1.1.0
secrets:
  - id: registry-user
    keyvault: https://acr-task-credentials.vault.azure.net/secrets/registry-acmerockets-user
  - id: registry-password
    keyvault: https://acr-task-credentials.vault.azure.net/secrets/registry-acmerockets-password
steps:
  # Build 
  - id: echo 
    cmd: bash echo KEYVAULT {{.Values.KEYVAULT}}
  - cmd: bash echo REGISTRY {{.Run.Registry}}
  - id: build-hello-world
    build: >
      --build-arg REGISTRY_FROM_URL={{.Values.REGISTRY_FROM_URL}} 
      -t {{.Run.Registry}}/hello-world:{{.Run.ID}} 
      -f Dockerfile 
      .
  - id: push-images
    when: ['build-hello-world']
    push: 
    - "{{.Run.Registry}}/hello-world:{{.Run.ID}}"
  - id: az-login
    # login with the identity of the task
    # run concurrently while the image is building: when: [-] indicates, wait for nothing
    cmd: az login --identity > /dev/null
  - cmd: bash echo ACI_RG {{.Values.ACI_RG}}
  - cmd: bash echo ACI {{.Values.ACI}}
  - cmd: bash echo IMAGE "{{.Run.Registry}}/hello-world:{{.Run.ID}}"
  - cmd: bash echo registry-username "{{.Secrets.registry-user}}"
